name: Comprehensive Testing Suite

on:
  push:
    branches: [ main, develop, 'copilot/**' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run ShellCheck
        run: |
          shellcheck --version
          find scripts -name "*.sh" -type f -print0 | xargs -0 shellcheck
      
      - name: Check formatting
        run: |
          # Check for trailing whitespace
          ! grep -r -n --include="*.sh" '[[:space:]]$' scripts/
  
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run unit tests
        run: |
          if [[ -x tests/run-all-tests.sh ]]; then
            tests/run-all-tests.sh
          else
            echo "No unit tests found"
          fi
  
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v4
      
      - name: Run integration tests
        run: |
          if [[ -d tests/integration ]]; then
            find tests/integration -name "test-*.sh" -type f -exec {} \;
          else
            echo "No integration tests found"
          fi
  
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run security scan
        run: |
          # Check for secrets in code
          ! grep -r -i "password\|secret\|api_key" --include="*.sh" scripts/ | grep -v "example\|template\|PASSWORD_FILE"
          echo "Security scan completed"
  
  performance-tests:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    needs: integration-tests
    steps:
      - uses: actions/checkout@v4
      
      - name: Run performance tests
        run: |
          if [[ -d tests/performance ]]; then
            find tests/performance -name "benchmark-*.sh" -type f -exec {} \;
          else
            echo "No performance tests found"
          fi
  
  deployment-validation:
    name: Deployment Validation
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan]
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate Docker configurations
        run: |
          docker-compose -f docker-compose.yml config
          docker-compose -f docker-compose.production.yml config
          docker-compose -f docker-compose-full-stack.yml config
      
      - name: Check documentation
        run: |
          # Verify key documentation files exist
          test -f README.md
          test -f DEPLOYMENT.md
          test -f CONTRIBUTING.md
          test -f CODE_OF_CONDUCT.md
          echo "Documentation validation completed"
