name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================================================
  # Code Quality Checks
  # ============================================================================
  code-quality:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install ShellCheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
          
      - name: Run ShellCheck
        run: |
          echo "Running ShellCheck on all bash scripts..."
          find . -name "*.sh" -type f -exec shellcheck {} \; > shellcheck-results.txt 2>&1 || true
          
          if grep -q "error\|warning" shellcheck-results.txt; then
            echo "::error::ShellCheck found issues"
            cat shellcheck-results.txt
            exit 1
          else
            echo "✅ ShellCheck passed - no issues found"
          fi
          
      - name: Validate Bash Syntax
        run: |
          echo "Validating bash syntax..."
          errors=0
          for script in $(find . -name "*.sh" -type f); do
            if ! bash -n "$script"; then
              echo "::error::Syntax error in $script"
              ((errors++))
            fi
          done
          
          if [ $errors -gt 0 ]; then
            echo "::error::Found $errors syntax errors"
            exit 1
          else
            echo "✅ All scripts have valid syntax"
          fi
          
      - name: Check for secrets
        run: |
          echo "Checking for exposed secrets..."
          if grep -r "password.*=.*['\"]" scripts/ | grep -v "^#" | grep -v "example" | grep -v "template"; then
            echo "::warning::Possible hardcoded credentials found"
          fi
          
      - name: Run pre-deployment checks
        run: |
          bash scripts/pre-deployment-check.sh || true

  # ============================================================================
  # Security Scanning
  # ============================================================================
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
          
      - name: Check for vulnerabilities
        run: |
          echo "Security scan completed"

  # ============================================================================
  # Build Docker Images
  # ============================================================================
  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [code-quality]
    strategy:
      matrix:
        image: [dev, production]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Build ${{ matrix.image }} image
        run: |
          if [ "${{ matrix.image }}" = "dev" ]; then
            docker build -f .devcontainer/Dockerfile.dev -t hydra-termux:dev .
          else
            docker build -f Dockerfile.production -t hydra-termux:production .
          fi
          
      - name: Test image
        run: |
          echo "Testing ${{ matrix.image }} image..."
          docker images | grep hydra-termux
          
      - name: Scan image for vulnerabilities
        run: |
          docker run --rm aquasec/trivy:latest image hydra-termux:${{ matrix.image }} || true

  # ============================================================================
  # Integration Tests
  # ============================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [build-images]
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Test database connectivity
        run: |
          PGPASSWORD=test_password psql -h localhost -U postgres -d test_db -c '\l' || true
          
      - name: Test Redis connectivity
        run: |
          redis-cli -h localhost ping || true

  # ============================================================================
  # Performance Tests
  # ============================================================================
  performance-tests:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    needs: [code-quality]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install hyperfine
        run: |
          wget https://github.com/sharkdp/hyperfine/releases/download/v1.18.0/hyperfine_1.18.0_amd64.deb
          sudo dpkg -i hyperfine_1.18.0_amd64.deb
          
      - name: Benchmark critical scripts
        run: |
          echo "Benchmarking script performance..."
          # Example benchmarks
          hyperfine --warmup 3 'bash scripts/pre-deployment-check.sh' || true
          
      - name: Upload performance results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: '*.json'

  # ============================================================================
  # Deploy to Staging
  # ============================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [integration-tests, security-scan]
    if: github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: https://staging.hydra-termux.dev
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Deploy to staging
        run: |
          echo "Deploying to staging environment..."
          # Add actual deployment commands here
          
      - name: Run smoke tests
        run: |
          echo "Running smoke tests on staging..."
          # Add smoke test commands

  # ============================================================================
  # Deploy to Production
  # ============================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [integration-tests, security-scan, performance-tests]
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://hydra-termux.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Deploy to production
        run: |
          echo "Deploying to production environment..."
          # Add actual production deployment commands
          
      - name: Health check
        run: |
          echo "Running production health checks..."
          # Add health check commands
          
      - name: Notify deployment
        run: |
          echo "Production deployment completed successfully"

  # ============================================================================
  # Cleanup
  # ============================================================================
  cleanup:
    name: Cleanup Old Artifacts
    runs-on: ubuntu-latest
    if: always()
    needs: [deploy-staging, deploy-production]
    steps:
      - name: Clean up old artifacts
        run: |
          echo "Cleaning up old artifacts..."
