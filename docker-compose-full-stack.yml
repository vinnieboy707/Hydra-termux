version: '3.8'

# ==============================================================================
# COMPREHENSIVE DOCKER ORCHESTRATION FOR HYDRA-TERMUX
# Complete stack with Supabase, PostgreSQL, Redis, Monitoring, and More
# ==============================================================================

services:
  # ============================================================================
  # PostgreSQL Database with All Extensions
  # ============================================================================
  postgres:
    image: supabase/postgres:15.1.0.147
    container_name: hydra-postgres
    restart: unless-stopped
    
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-your_secure_password}
      POSTGRES_DB: ${POSTGRES_DB:-hydra_db}
      POSTGRES_HOST_AUTH_METHOD: md5
      PGDATA: /var/lib/postgresql/data/pgdata
    
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./fullstack-app/backend/schema:/docker-entrypoint-initdb.d:ro
      - postgres-backups:/backups
    
    networks:
      - hydra-network
    
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    
    command: >
      postgres
      -c shared_preload_libraries=pg_stat_statements,pg_cron
      -c pg_stat_statements.track=all
      -c max_connections=200
      -c shared_buffers=256MB
      -c effective_cache_size=1GB
      -c maintenance_work_mem=64MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=4MB
      -c min_wal_size=1GB
      -c max_wal_size=4GB
      -c max_worker_processes=4
      -c max_parallel_workers_per_gather=2
      -c max_parallel_workers=4
      -c max_parallel_maintenance_workers=2

  # ============================================================================
  # Redis for Caching, Sessions, and Rate Limiting
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: hydra-redis
    restart: unless-stopped
    
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:-your_secure_redis_password}
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
      --appendonly yes
      --appendfsync everysec
    
    ports:
      - "${REDIS_PORT:-6379}:6379"
    
    volumes:
      - redis-data:/data
    
    networks:
      - hydra-network
    
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PASSWORD:-your_secure_redis_password}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # Supabase Studio (Local Development)
  # ============================================================================
  supabase-studio:
    image: supabase/studio:latest
    container_name: hydra-supabase-studio
    restart: unless-stopped
    
    environment:
      SUPABASE_URL: ${SUPABASE_URL:-http://localhost:54321}
      STUDIO_PG_META_URL: http://postgres-meta:8080
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
    
    ports:
      - "${SUPABASE_STUDIO_PORT:-3000}:3000"
    
    networks:
      - hydra-network
    
    depends_on:
      - postgres

  # ============================================================================
  # PostgREST API Layer
  # ============================================================================
  postgrest:
    image: postgrest/postgrest:latest
    container_name: hydra-postgrest
    restart: unless-stopped
    
    environment:
      PGRST_DB_URI: postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-hydra_db}
      PGRST_DB_SCHEMA: public
      PGRST_DB_ANON_ROLE: anon
      PGRST_JWT_SECRET: ${JWT_SECRET}
      PGRST_DB_USE_LEGACY_GUCS: "false"
    
    ports:
      - "${POSTGREST_PORT:-3001}:3000"
    
    networks:
      - hydra-network
    
    depends_on:
      postgres:
        condition: service_healthy

  # ============================================================================
  # Backend Application Server
  # ============================================================================
  backend:
    build:
      context: ./fullstack-app/backend
      dockerfile: Dockerfile
    container_name: hydra-backend
    restart: unless-stopped
    
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 4000
      DATABASE_URL: postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-hydra_db}
      REDIS_URL: redis://:${REDIS_PASSWORD:-your_secure_redis_password}@redis:6379
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      JWT_SECRET: ${JWT_SECRET}
      SESSION_SECRET: ${SESSION_SECRET}
    
    ports:
      - "${BACKEND_PORT:-4000}:4000"
    
    volumes:
      - ./fullstack-app/backend:/app
      - /app/node_modules
      - backend-uploads:/app/uploads
      - backend-logs:/app/logs
    
    networks:
      - hydra-network
    
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # Frontend Application
  # ============================================================================
  frontend:
    build:
      context: ./fullstack-app/frontend
      dockerfile: Dockerfile
    container_name: hydra-frontend
    restart: unless-stopped
    
    environment:
      REACT_APP_API_URL: ${REACT_APP_API_URL:-http://localhost:4000}
      REACT_APP_SUPABASE_URL: ${SUPABASE_URL}
      REACT_APP_SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
    
    ports:
      - "${FRONTEND_PORT:-3002}:80"
    
    networks:
      - hydra-network
    
    depends_on:
      - backend

  # ============================================================================
  # Nginx Reverse Proxy with SSL Support
  # ============================================================================
  nginx:
    image: nginx:alpine
    container_name: hydra-nginx
    restart: unless-stopped
    
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx-logs:/var/log/nginx
      - nginx-cache:/var/cache/nginx
    
    networks:
      - hydra-network
    
    depends_on:
      - backend
      - frontend
    
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # Prometheus Monitoring
  # ============================================================================
  prometheus:
    image: prom/prometheus:latest
    container_name: hydra-prometheus
    restart: unless-stopped
    
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    
    volumes:
      - ./monitoring/prometheus:/etc/prometheus:ro
      - prometheus-data:/prometheus
    
    networks:
      - hydra-network
    
    depends_on:
      - postgres
      - redis
      - backend

  # ============================================================================
  # Grafana Dashboards
  # ============================================================================
  grafana:
    image: grafana/grafana:latest
    container_name: hydra-grafana
    restart: unless-stopped
    
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
      GF_INSTALL_PLUGINS: grafana-clock-panel,grafana-simple-json-datasource
    
    ports:
      - "${GRAFANA_PORT:-3003}:3000"
    
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    
    networks:
      - hydra-network
    
    depends_on:
      - prometheus

  # ============================================================================
  # Redis Insight (Redis Management UI)
  # ============================================================================
  redis-insight:
    image: redislabs/redisinsight:latest
    container_name: hydra-redis-insight
    restart: unless-stopped
    
    ports:
      - "${REDIS_INSIGHT_PORT:-8001}:8001"
    
    volumes:
      - redis-insight-data:/db
    
    networks:
      - hydra-network
    
    depends_on:
      - redis

  # ============================================================================
  # Adminer (Database Management UI)
  # ============================================================================
  adminer:
    image: adminer:latest
    container_name: hydra-adminer
    restart: unless-stopped
    
    environment:
      ADMINER_DEFAULT_SERVER: postgres
      ADMINER_DESIGN: nette
    
    ports:
      - "${ADMINER_PORT:-8080}:8080"
    
    networks:
      - hydra-network
    
    depends_on:
      - postgres

  # ============================================================================
  # Webhook Delivery Worker
  # ============================================================================
  webhook-worker:
    build:
      context: ./fullstack-app/backend
      dockerfile: Dockerfile.worker
    container_name: hydra-webhook-worker
    restart: unless-stopped
    
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      DATABASE_URL: postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-hydra_db}
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
      WORKER_TYPE: webhook_delivery
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
    
    networks:
      - hydra-network
    
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ============================================================================
  # Points Processing Worker
  # ============================================================================
  points-worker:
    build:
      context: ./fullstack-app/backend
      dockerfile: Dockerfile.worker
    container_name: hydra-points-worker
    restart: unless-stopped
    
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      DATABASE_URL: postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-hydra_db}
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
      WORKER_TYPE: points_processing
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
    
    networks:
      - hydra-network
    
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ============================================================================
  # Scheduled Jobs Runner
  # ============================================================================
  scheduler:
    build:
      context: ./fullstack-app/backend
      dockerfile: Dockerfile.scheduler
    container_name: hydra-scheduler
    restart: unless-stopped
    
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      DATABASE_URL: postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-hydra_db}
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
    
    networks:
      - hydra-network
    
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

# ==============================================================================
# NETWORKS
# ==============================================================================
networks:
  hydra-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16

# ==============================================================================
# VOLUMES
# ==============================================================================
volumes:
  postgres-data:
    driver: local
  
  postgres-backups:
    driver: local
  
  redis-data:
    driver: local
  
  backend-uploads:
    driver: local
  
  backend-logs:
    driver: local
  
  nginx-logs:
    driver: local
  
  nginx-cache:
    driver: local
  
  prometheus-data:
    driver: local
  
  grafana-data:
    driver: local
  
  redis-insight-data:
    driver: local

# ==============================================================================
# DEPLOYMENT NOTES
# ==============================================================================
# 
# Quick Start:
#   docker-compose -f docker-compose-full-stack.yml up -d
# 
# View Logs:
#   docker-compose -f docker-compose-full-stack.yml logs -f [service-name]
# 
# Stop All:
#   docker-compose -f docker-compose-full-stack.yml down
# 
# Rebuild:
#   docker-compose -f docker-compose-full-stack.yml up -d --build
# 
# Services:
#   - Frontend: http://localhost:3002
#   - Backend API: http://localhost:4000
#   - Supabase Studio: http://localhost:3000
#   - PostgREST: http://localhost:3001
#   - PostgreSQL: localhost:5432
#   - Redis: localhost:6379
#   - Prometheus: http://localhost:9090
#   - Grafana: http://localhost:3003
#   - Adminer: http://localhost:8080
#   - Redis Insight: http://localhost:8001
#   - Nginx: http://localhost (80/443)
# 
# ==============================================================================
